<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cloud AI é«”é©—ç‰ˆ (æ¨¡æ“¬)</title>
    <style>
        body { margin: 0; background: #f0f2f5; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; }
        
        /* æ¨™é¡Œå€ */
        header {
            width: 100%; padding: 15px; background: #4285f4; color: white;
            text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        h1 { margin: 0; font-size: 20px; }
        p { margin: 5px 0 0; font-size: 12px; opacity: 0.8; }

        /* è¦–è¨Šé è¦½å€ */
        #container {
            position: relative; width: 100%; max-width: 640px; margin-top: 20px;
        }
        
        video {
            width: 100%; border-radius: 10px; display: block;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* ç¹ªåœ–å±¤ (é¡¯ç¤ºçµæœ) */
        canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; border-radius: 10px;
        }

        /* æŒ‰éˆ•å€ */
        .controls {
            margin-top: 20px; display: flex; gap: 10px;
        }

        button {
            padding: 15px 30px; font-size: 18px; border: none; border-radius: 50px;
            background: #4285f4; color: white; cursor: pointer;
            box-shadow: 0 4px 0 #2a56c6; transition: transform 0.1s;
            display: flex; align-items: center; gap: 10px;
        }
        button:active { transform: translateY(4px); box-shadow: none; }
        button:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        /* æ¨¡æ“¬è®€å–ç•«é¢ (é›²ç«¯æ‹›ç‰Œè½‰åœˆåœˆ) */
        #loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); border-radius: 10px;
            display: none; flex-direction: column;
            justify-content: center; align-items: center; color: white;
        }

        .spinner {
            width: 40px; height: 40px; border: 5px solid #fff;
            border-top: 5px solid transparent; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ•¸æ“šé¡¯ç¤º */
        #stats {
            margin-top: 20px; padding: 15px; background: white;
            border-radius: 8px; width: 90%; max-width: 600px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-family: monospace;
        }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stat-val { font-weight: bold; color: #4285f4; }

    </style>
</head>
<body>

    <header>
        <h1>â˜ï¸ Cloud AI Object Detection</h1>
        <p>æ¶æ§‹ï¼šæ‹ç…§ -> ä¸Šå‚³ -> é›²ç«¯é‹ç®— -> å›å‚³çµæœ</p>
    </header>

    <div id="container">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="output-canvas"></canvas>
        
        <div id="loading-overlay">
            <div class="spinner"></div>
            <div id="loading-text">Uploading image...</div>
        </div>
    </div>

    <div class="controls">
        <button id="snap-btn" onclick="captureAndDetect()">
            <span>ğŸ“¸</span> æ‹ç…§ä¸¦ä¸Šå‚³åˆ†æ
        </button>
    </div>

    <div id="stats">
        <div class="stat-row">ç‹€æ…‹: <span id="status-val" class="stat-val">å¾…æ©Ÿ</span></div>
        <div class="stat-row">ç¶²è·¯å»¶é² (Latency): <span id="latency-val" class="stat-val">0 ms</span></div>
        <div class="stat-row">è¾¨è­˜ç‰©ä»¶æ•¸: <span id="obj-val" class="stat-val">0</span></div>
    </div>

    <script type="module">
        import { FilesetResolver, ObjectDetector } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2";

        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output-canvas');
        const ctx = canvas.getContext('2d');
        const snapBtn = document.getElementById('snap-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        // ç‹€æ…‹é¡¯ç¤º
        const statusVal = document.getElementById('status-val');
        const latencyVal = document.getElementById('latency-val');
        const objVal = document.getElementById('obj-val');

        let objectDetector;
        let runningMode = "IMAGE"; // æ³¨æ„ï¼šé€™è£¡æ”¹æˆ IMAGE æ¨¡å¼ï¼Œæ¨¡æ“¬å–®å¼µåœ–ç‰‡è™•ç†

        // 1. åˆå§‹åŒ–æ¨¡å‹ (é›–ç„¶æ˜¯åœ¨æœ¬åœ°ï¼Œä½†æˆ‘å€‘å‡è£å®ƒæ˜¯é›²ç«¯å¼•æ“)
        async function init() {
            snapBtn.innerText = "ç³»çµ±å•Ÿå‹•ä¸­...";
            snapBtn.disabled = true;

            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/wasm"
            );
            
            objectDetector = await ObjectDetector.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite`,
                    delegate: "GPU"
                },
                scoreThreshold: 0.35,
                runningMode: runningMode
            });

            snapBtn.innerText = "ğŸ“¸ æ‹ç…§ä¸¦ä¸Šå‚³åˆ†æ";
            snapBtn.disabled = false;
            
            // é–‹å•Ÿç›¸æ©Ÿ
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then((stream) => {
                video.srcObject = stream;
            });
        }

        // 2. æ¨¡æ“¬é›²ç«¯æµç¨‹ (æ ¸å¿ƒæ•™å­¸é‚è¼¯)
        window.captureAndDetect = async function() {
            if (!objectDetector) return;

            // --- æ­¥é©Ÿ A: å‡çµç•«é¢ (æ¨¡æ“¬æ‹ç…§) ---
            video.pause();
            snapBtn.disabled = true;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©ºèˆŠçš„æ¡†
            
            // --- æ­¥é©Ÿ B: æ¨¡æ“¬ä¸Šå‚³å»¶é² (Network Latency) ---
            loadingOverlay.style.display = 'flex';
            statusVal.innerText = "ä¸Šå‚³åœ–ç‰‡ä¸­...";
            loadingText.innerText = "Uploading to server (1.2MB)...";
            
            let startTime = performance.now();

            // éš¨æ©Ÿå»¶é² 1.5ç§’ ~ 3ç§’ (æ¨¡æ“¬ 4G è¨Šè™Ÿ)
            const fakeNetworkLag = 1500 + Math.random() * 1500;
            
            await new Promise(resolve => setTimeout(resolve, fakeNetworkLag * 0.6)); // ä¸Šå‚³æ™‚é–“
            
            statusVal.innerText = "é›²ç«¯ GPU é‹ç®—ä¸­...";
            loadingText.innerText = "Processing on Cloud GPU...";
            
            await new Promise(resolve => setTimeout(resolve, fakeNetworkLag * 0.4)); // é‹ç®—èˆ‡å›å‚³æ™‚é–“

            // --- æ­¥é©Ÿ C: åŸ·è¡Œè¾¨è­˜ (é€™è£¡å…¶å¯¦é‚„æ˜¯ Local è·‘çš„ï¼Œä½†å­¸ç”Ÿæ„Ÿè¦ºä¸å‡ºä¾†) ---
            // ç¢ºä¿ canvas å°ºå¯¸æ­£ç¢º
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const detections = objectDetector.detect(video); // ä½¿ç”¨ detect (å–®å¼µ) è€Œé detectForVideo (ä¸²æµ)
            
            // --- æ­¥é©Ÿ D: é¡¯ç¤ºçµæœ ---
            loadingOverlay.style.display = 'none';
            displayImageDetections(detections);
            
            let endTime = performance.now();
            let totalLatency = (endTime - startTime).toFixed(0);

            // æ›´æ–°æ•¸æ“š UI
            statusVal.innerText = "æ¥æ”¶å›å‚³è³‡æ–™æˆåŠŸ";
            latencyVal.innerText = `${totalLatency} ms`;
            latencyVal.style.color = "red"; // ç´…è‰²å¼·èª¿å»¶é²å¾ˆé«˜
            objVal.innerText = detections.detections.length;

            snapBtn.innerText = "ğŸ”„ é‡è¨­ / å†æ‹ä¸€å¼µ";
            snapBtn.onclick = resetCamera;
            snapBtn.disabled = false;
        }

        function resetCamera() {
            video.play(); // æ¢å¾©ç›¸æ©Ÿç•«é¢
            ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…æ‰æ¡†æ¡†
            statusVal.innerText = "å¾…æ©Ÿ";
            latencyVal.innerText = "0 ms";
            objVal.innerText = "0";
            
            snapBtn.innerText = "ğŸ“¸ æ‹ç…§ä¸¦ä¸Šå‚³åˆ†æ";
            snapBtn.onclick = window.captureAndDetect;
        }

        function displayImageDetections(result) {
            for (const detection of result.detections) {
                const box = detection.boundingBox;
                
                // ç•«æ¡†
                ctx.lineWidth = 4;
                ctx.strokeStyle = "#4285f4"; // ä½¿ç”¨ Google è—ï¼Œå€åˆ¥æ–¼ Edge çš„ç¶ è‰²
                ctx.beginPath();
                ctx.rect(box.originX, box.originY, box.width, box.height);
                ctx.stroke();

                // ç•«æ¨™ç±¤
                const category = detection.categories[0];
                const labelText = `${category.categoryName} ${Math.round(category.score * 100)}%`;
                
                ctx.font = "16px Arial";
                ctx.fillStyle = "#4285f4";
                const textWidth = ctx.measureText(labelText).width;
                ctx.fillRect(box.originX, box.originY - 25, textWidth + 10, 25);

                ctx.fillStyle = "white";
                ctx.fillText(labelText, box.originX + 5, box.originY - 7);
            }
        }

        init();
    </script>
</body>
</html>
