<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI è¡¨æƒ…å¤§æŒ‘æˆ°</title>
    <style>
        body { margin: 0; background: #2c3e50; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        
        /* éŠæˆ²å€åŸŸ */
        #game-container {
            position: relative;
            width: 100vw; height: 100vh;
            overflow: hidden;
        }

        /* è¦–è¨Šå±¤ (é¡åƒ) */
        video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1);
        }

        /* UI å±¤ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 20px 0;
        }

        /* ç›®æ¨™ Emoji é¡¯ç¤º */
        #target-emoji {
            font-size: 120px;
            margin-top: 50px;
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.5));
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* åˆ†æ•¸èˆ‡å€’æ•¸ */
        .status-bar {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 30px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: bold;
            display: flex; gap: 20px;
            backdrop-filter: blur(5px);
        }

        /* ç›¸ä¼¼åº¦æ¢ */
        #match-meter-container {
            width: 80%; height: 30px;
            background: rgba(255,255,255,0.3);
            border-radius: 15px;
            margin-bottom: 50px;
            position: relative;
            overflow: hidden;
            border: 2px solid white;
        }
        #match-meter {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #f1c40f, #e67e22);
            transition: width 0.1s;
        }
        #match-text {
            position: absolute; width: 100%; text-align: center; top: 2px;
            color: white; font-weight: bold; text-shadow: 1px 1px 2px black;
        }

        /* ç‰¹æ•ˆå‹•ç•« */
        @keyframes pop {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .success-anim { animation: success 0.5s ease-out; }
        @keyframes success {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        /* è¼‰å…¥é®ç½© */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #fff; z-index: 999;
            display: flex; justify-content: center; align-items: center; font-size: 20px;
        }
    </style>
</head>
<body>

    <div id="loading">æ­£åœ¨è¼‰å…¥è‡‰éƒ¨æ¨¡å‹...<br>è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™</div>

    <div id="game-container">
        <video id="webcam" autoplay playsinline></video>
        
        <div id="ui-layer">
            <div class="status-bar">
                <span id="score">å¾—åˆ†: 0</span>
                <span id="timer">æ™‚é–“: 60</span>
            </div>

            <div id="target-emoji">ğŸ¤”</div>

            <div id="match-meter-container">
                <div id="match-meter"></div>
                <div id="match-text">ç›¸ä¼¼åº¦: 0%</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { FilesetResolver, FaceLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

        const video = document.getElementById('webcam');
        const targetEmojiEl = document.getElementById('target-emoji');
        const matchMeter = document.getElementById('match-meter');
        const matchText = document.getElementById('match-text');
        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const loadingEl = document.getElementById('loading');

        let faceLandmarker;
        let lastVideoTime = -1;
        let score = 0;
        let timeLeft = 60;
        let gameActive = false;
        
        // å®šç¾©é—œå¡ (Emoji å°æ‡‰çš„ Blendshape é‚è¼¯)
        const levels = [
            { 
                emoji: "ğŸ˜®", 
                name: "Surprise", 
                // é‚è¼¯: å˜´å·´å¼µé–‹ + çœ‰æ¯›æŠ¬èµ·
                check: (shapes) => (shapes["jawOpen"] + shapes["browInnerUp"]) / 2 
            },
            { 
                emoji: "ğŸ˜‰", 
                name: "Wink", 
                // é‚è¼¯: å·¦çœ¼é–‰ (æ•¸å€¼é«˜) - å³çœ¼é–‰ (æ•¸å€¼ä½) çš„å·®å€¼è¦å¤§ï¼Œæˆ–è€…åéä¾†
                check: (shapes) => Math.abs(shapes["eyeBlinkLeft"] - shapes["eyeBlinkRight"]) 
            },
            { 
                emoji: "ğŸ˜", 
                name: "Smile", 
                // é‚è¼¯: å˜´è§’ä¸Šæš (å·¦å³å¹³å‡)
                check: (shapes) => (shapes["mouthSmileLeft"] + shapes["mouthSmileRight"]) / 2 
            },
            { 
                emoji: "ğŸ˜—", 
                name: "Kiss", 
                // é‚è¼¯: å˜´å·´å˜Ÿèµ·
                check: (shapes) => shapes["mouthPucker"] 
            },
             { 
                emoji: "ğŸ˜‘", 
                name: "Blink", 
                // é‚è¼¯: é›™çœ¼é–‰ä¸Š
                check: (shapes) => (shapes["eyeBlinkLeft"] + shapes["eyeBlinkRight"]) / 2 
            }
        ];

        let currentLevel = null;
        let blendshapesMap = {}; // å„²å­˜ç•¶å‰å¹€çš„å½¢ç‹€æ•¸å€¼

        // 1. åˆå§‹åŒ– AI
        async function initAI() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numFaces: 1,
                outputFaceBlendshapes: true // é—œéµï¼šé–‹å•Ÿ Blendshapes è¼¸å‡º
            });
            startCamera();
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then((stream) => {
                video.srcObject = stream;
                video.addEventListener("loadeddata", () => {
                    loadingEl.style.display = 'none';
                    startGame();
                    predictLoop();
                });
            });
        }

        // éŠæˆ²é‚è¼¯
        function startGame() {
            gameActive = true;
            nextLevel();
            // å€’æ•¸è¨ˆæ™‚
            setInterval(() => {
                if(timeLeft > 0 && gameActive) {
                    timeLeft--;
                    timerEl.innerText = "æ™‚é–“: " + timeLeft;
                } else if (timeLeft <= 0) {
                    gameActive = false;
                    targetEmojiEl.innerText = "ğŸ";
                    matchText.innerText = "éŠæˆ²çµæŸ!";
                }
            }, 1000);
        }

        function nextLevel() {
            // éš¨æ©Ÿé¸ä¸€å€‹è¡¨æƒ…
            const idx = Math.floor(Math.random() * levels.length);
            currentLevel = levels[idx];
            targetEmojiEl.innerText = currentLevel.emoji;
            // é‡ç½®å‹•ç•«
            targetEmojiEl.style.animation = 'none';
            targetEmojiEl.offsetHeight; /* trigger reflow */
            targetEmojiEl.style.animation = 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        }

        // 2. AI é æ¸¬å¾ªç’°
        async function predictLoop() {
            if (lastVideoTime !== video.currentTime && faceLandmarker) {
                lastVideoTime = video.currentTime;
                const results = faceLandmarker.detectForVideo(video, performance.now());

                if (results.faceBlendshapes && results.faceBlendshapes.length > 0) {
                    const shapes = results.faceBlendshapes[0].categories;
                    
                    // å°‡é™£åˆ—è½‰ç‚ºæ–¹ä¾¿æŸ¥è©¢çš„ Object: { "jawOpen": 0.8, ... }
                    shapes.forEach(s => {
                        blendshapesMap[s.categoryName] = s.score;
                    });

                    if (gameActive && currentLevel) {
                        // è¨ˆç®—ç•¶å‰è¡¨æƒ…çš„åˆ†æ•¸ (0.0 ~ 1.0)
                        const scoreVal = currentLevel.check(blendshapesMap);
                        const percentage = Math.min(100, Math.floor(scoreVal * 100));

                        // æ›´æ–° UI
                        matchMeter.style.width = percentage + "%";
                        matchText.innerText = `ç›¸ä¼¼åº¦: ${percentage}%`;

                        // åˆ¤æ–·æ˜¯å¦éé—œ (é–¾å€¼è¨­ç‚º 0.6ï¼Œå³ 60% åƒ)
                        if (scoreVal > 0.6) {
                            handleSuccess();
                        }
                    }
                }
            }
            requestAnimationFrame(predictLoop);
        }

        let isCooldown = false;
        function handleSuccess() {
            if (isCooldown) return;
            isCooldown = true;
            
            score++;
            scoreEl.innerText = "å¾—åˆ†: " + score;
            targetEmojiEl.classList.add("success-anim");
            matchText.innerText = "å®Œç¾!! âœ¨";
            matchMeter.style.background = "#2ed573"; // è®Šç¶ è‰²

            if (navigator.vibrate) navigator.vibrate(100); // éœ‡å‹•å›é¥‹

            setTimeout(() => {
                matchMeter.style.background = "linear-gradient(90deg, #f1c40f, #e67e22)";
                targetEmojiEl.classList.remove("success-anim");
                nextLevel();
                isCooldown = false;
            }, 800);
        }

        initAI();
    </script>
</body>
</html>