<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>On-Device 物件偵測</title>
    <style>
        body { margin: 0; background: #000; font-family: 'Courier New', Courier, monospace; overflow: hidden; }
        
        #container { position: relative; width: 100vw; height: 100vh; }
        
        /* 視訊層 */
        video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
        }

        /* 繪圖層 (Box & Label) */
        canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
        }

        /* 終結者風格 UI - 數據面板 */
        #hud-layer {
            position: absolute; top: 20px; left: 20px; z-index: 20;
            color: #00ff00; text-shadow: 0 0 5px #00ff00;
            pointer-events: none;
        }

        .hud-item { margin-bottom: 5px; font-size: 14px; font-weight: bold; }
        .hud-value { color: #fff; }

        /* 掃描線特效 */
        #scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: rgba(0, 255, 0, 0.5);
            box-shadow: 0 0 10px #00ff00;
            animation: scan 3s linear infinite;
            z-index: 5; opacity: 0.3;
            pointer-events: none;
        }

        @keyframes scan {
            0% { top: 0%; }
            100% { top: 100%; }
        }

        /* 載入畫面 */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #00ff00;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 999;
        }
        .loader-bar {
            width: 200px; height: 4px; background: #333; margin-top: 20px;
        }
        .loader-progress {
            width: 0%; height: 100%; background: #00ff00; transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div style="position:fixed; top:10px; right:10px; z-index:9999;">
    <a href="cloud.html" style="background:white; padding:10px; border-radius:5px; text-decoration:none; font-weight:bold; border:2px solid black;">
        ☁️ 體驗 Cloud 版本
    </a>
</div>
    <div id="loading">
        <div style="font-size: 20px; font-weight: bold;">SYSTEM BOOTING...</div>
        <div style="font-size: 12px; margin-top: 10px;">Downloading Neural Network (Lite0)</div>
        <div class="loader-bar"><div class="loader-progress" id="progress"></div></div>
    </div>

    <div id="container">
        <video id="webcam" autoplay playsinline muted></video>
        <div id="scan-line"></div>
        <canvas id="output-canvas"></canvas>
        
        <div id="hud-layer">
            <div class="hud-item">AI MODEL: <span class="hud-value">EfficientDet-Lite0</span></div>
            <div class="hud-item">DEVICE: <span class="hud-value">GPU/NPU</span></div>
            <div class="hud-item">INFERENCE: <span class="hud-value" id="fps-display">0 ms</span></div>
            <div class="hud-item">OBJECTS: <span class="hud-value" id="obj-count">0</span></div>
            <div class="hud-item" style="margin-top: 10px; color: yellow;">★ 載入完成後請試著斷網</div>
        </div>
    </div>

    <script type="module">
        import { FilesetResolver, ObjectDetector } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2";

        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output-canvas');
        const ctx = canvas.getContext('2d');
        const fpsDisplay = document.getElementById('fps-display');
        const objCountDisplay = document.getElementById('obj-count');
        const loadingScreen = document.getElementById('loading');
        const progressBar = document.getElementById('progress');

        let objectDetector;
        let runningMode = "VIDEO";
        let lastVideoTime = -1;
        let lastInferenceTime = 0;

        // 1. 初始化物件偵測模型
        async function init() {
            progressBar.style.width = "30%";
            
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/wasm"
            );
            
            progressBar.style.width = "60%";

            // 下載 EfficientDet 模型 (約 4MB)
            objectDetector = await ObjectDetector.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite`,
                    delegate: "GPU" // 強制使用 GPU 加速
                },
                scoreThreshold: 0.50, // 信心分數門檻 (35% 以上才顯示)
                runningMode: runningMode
            });

            progressBar.style.width = "100%";
            setTimeout(() => { loadingScreen.style.display = 'none'; }, 500);
            
            enableCam();
        }

        // 2. 開啟相機
        function enableCam() {
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } // 預設使用後鏡頭
            }).then((stream) => {
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
            });
        }

        // 3. 預測循環
        async function predictWebcam() {
            // 調整 Canvas 尺寸
            if(canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }

            let startTimeMs = performance.now();

            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                
                // 核心推論步驟
                const detections = objectDetector.detectForVideo(video, startTimeMs);
                
                // 計算推論時間
                const inferenceTime = (performance.now() - startTimeMs).toFixed(1);
                fpsDisplay.innerText = `${inferenceTime} ms`; // 顯示毫秒數

                // 繪製結果
                displayVideoDetections(detections);
            }

            window.requestAnimationFrame(predictWebcam);
        }

        // 繪圖函式
        function displayVideoDetections(result) {
            // 清空畫布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            objCountDisplay.innerText = result.detections.length;

            for (const detection of result.detections) {
                // 畫框框
                const box = detection.boundingBox;
                
                // 邊框樣式 (科幻風)
                ctx.lineWidth = 3;
                ctx.strokeStyle = "#00ff00"; 
                ctx.beginPath();
                ctx.rect(box.originX, box.originY, box.width, box.height);
                ctx.stroke();

                // 角落加粗 (裝飾)
                drawCorner(box.originX, box.originY); // 左上
                drawCorner(box.originX + box.width, box.originY); // 右上
                drawCorner(box.originX, box.originY + box.height); // 左下
                drawCorner(box.originX + box.width, box.originY + box.height); // 右下

                // 顯示標籤文字 (例如: cup 98%)
                const category = detection.categories[0];
                const labelText = `${category.categoryName} ${Math.round(category.score * 100)}%`;
                
                ctx.font = "18px Courier New";
                const textWidth = ctx.measureText(labelText).width;

                // 文字背景
                ctx.fillStyle = "rgba(0, 255, 0, 0.7)";
                ctx.fillRect(box.originX, box.originY - 25, textWidth + 10, 25);

                // 文字本體
                ctx.fillStyle = "black";
                ctx.fillText(labelText, box.originX + 5, box.originY - 7);
            }
        }

        function drawCorner(x, y) {
            ctx.fillStyle = "#00ff00";
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
        }

        init();
    </script>
</body>
</html>
